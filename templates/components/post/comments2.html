{% load static %}
<h3>Comments:</h3>
<div id="comments-{{ post.id }}">
    <div class="comment-list flex flex-col gap-3">
        <!-- ROOT COMMENTS -->
        {% for comment in root_comments reversed %}
        <div id="comment-{{ comment.id }}" class="comment-container flex flex-col gap-2 pl-0">
            <div class="flex flex-row gap-2 items-start relative">
                <!-- USER -->
                <div class="w-[30px] h-[30px] rounded-full relative">
                    {% if comment.user.avatar %}
                        {% if comment.user.avatar|slice:":5" == "https" %}
                            <img class="w-[30px] h-[30px] rounded-full object-cover" 
                                 src="{{ comment.user.avatar }}" 
                                 alt="{{ comment.user.username }}">
                        {% else %}
                            <img class="w-[30px] h-[30px] rounded-full object-cover" 
                                 src="{% static comment.user.avatar %}" 
                                 alt="{{ comment.user.username }}">
                        {% endif %}
                    {% else %}
                        <div class="w-full h-full bg-black rounded-full"></div>
                    {% endif %}
                </div>

                <!-- COMMENT HEADER -->
                <div class="flex flex-col gap-1 w-full">
                    <div class="flex flex-row gap-2 items-center">
                        <a href="{% url 'account:user_profile' comment.user.username %}" 
                           class="font-semibold text-sm">
                            {{ comment.user.username }}
                        </a>
                        <p class="text-xs text-gray-500">•</p>
                        <p class="text-xs text-gray-500" data-created-at="{{ comment.created_at }}">
                            {{ comment.created_at }}
                        </p>
                    </div>

                    <!-- CONTENT -->
                    <p class="text-sm">{{ comment.content }}</p>

                    <!-- ACTIONS -->
                    <div class="flex flex-row gap-2 mt-1">
                        <button class="text-xs text-pink-500 reply-button" 
                                data-parent-id="{{ comment.id }}"
                                onclick="showReplyBox('{{ comment.id }}')">
                            Reply
                        </button>

                        <button class="text-xs text-green-500 edit-button" 
                                data-comment-id="{{ comment.id }}">
                            Edit
                        </button>
                        {% if comment.user == user %}
                        <button class="text-xs text-red-500 delete-button" 
                                data-comment-id="{{ comment.id }}"
                                onclick="delete_comment('{{ comment.id }}')">
                            Delete
                        </button>  
                        {% endif %}    
                    </div>
                    <div class="w-full mt-2 hidden reply-box" id="reply-box-{{ comment.id }}">
                        <div class="w-full rounded-lg border border-gray-300 bg-white-500 overflow-hidden">
                            <textarea id="commentBox-{{ comment.id }}" placeholder="Add a reply..."
                                      class="w-full p-2 transition-all h-10 resize-none"
                                      style="border: none; outline: none; padding: 10px; resize: none; min-height: 80px; box-shadow: none;"></textarea>
                            <div id="buttonContainer-{{ comment.id }}" class="justify-end p-2.5 border-t-none bg-white float-right">
                                <button style="margin-right: 10px; padding: 5px 10px; border: none; background-color: white; border-radius: 15px;"
                                        class="inline-flex items-center px-2 py-1 bg-gray-200 border border-gray-300 rounded-full hover:bg-gray-300 mr-2 text-sm"
                                        onclick="cancelComment()">Cancel</button>
                                <button style="padding: 5px 10px; border: none; background-color: #1a73e8; color: white; border-radius: 15px;"
                                        class="inline-flex items-center px-2 py-1 bg-blue-600 text-white rounded-full hover:bg-blue-700 text-sm"
                                        onclick="submitReply('{{ comment.id }}')">
                                    Comment
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- CHILD COMMENTS -->
                    <div class="child-comments ml-3 mt-2">
                        {% for child_comment in comment.replies.all reversed %}
                        <div id="comment-{{ child_comment.id }}" class="flex flex-col gap-2 border-l-2 pl-2 mt-2">
                            <div class="flex flex-row gap-2 items-start relative">
                                <!-- AVATAR -->
                                <div class="w-[25px] h-[25px] rounded-full relative">
                                    {% if child_comment.user.avatar %}
                                        {% if child_comment.user.avatar|slice:":5" == "https" %}
                                            <img class="w-[25px] h-[25px] rounded-full object-cover" 
                                                 src="{{ child_comment.user.avatar }}" 
                                                 alt="{{ child_comment.user.username }}">
                                        {% else %}
                                            <img class="w-[25px] h-[25px] rounded-full object-cover" 
                                                 src="{% static child_comment.user.avatar %}" 
                                                 alt="{{ child_comment.user.username }}">
                                        {% endif %}
                                    {% else %}
                                        <div class="w-full h-full bg-black rounded-full"></div>
                                    {% endif %}
                                </div>
                    
                                <!-- CHILD COMMENT HEADER -->
                                <div class="flex flex-col gap-1 w-full">
                                    <div class="flex flex-row gap-2 items-center">
                                        <a href="{% url 'account:user_profile' child_comment.user.username %}" 
                                           class="font-semibold text-sm">
                                            {{ child_comment.user.username }}
                                        </a>
                                        <p class="text-xs text-gray-500">•</p>
                                        <p class="text-xs text-gray-500" data-created-at="{{ child_comment.created_at }}">
                                            {{ child_comment.created_at }}
                                        </p>
                                    </div>
                    
                                    <!-- CHILD COMMENT CONTENT -->
                                    <p class="text-sm">{{ child_comment.content }}</p>
                    
                                    <!-- CHILD CONTENT ACTIONS -->
                                    <div class="flex flex-row gap-2 mt-1">
                                        <button class="text-xs text-pink-500 reply-button" 
                                                data-parent-id="{{ child_comment.id }}"
                                                onclick="showReplyBox('{{ child_comment.id }}')">
                                            Reply
                                        </button>
                                        <button class="text-xs text-green-500 edit-button" 
                                                data-comment-id="{{ child_comment.id }}">
                                            Edit
                                        </button>
                                        <button class="text-xs text-red-500 delete-button" 
                                                data-comment-id="{{ child_comment.id }}">
                                            Delete
                                        </button>
                                    </div>
                    
                                    <!-- REPLY BOX FOR CHILD COMMENTS -->
                                    <div class="w-full mt-2 hidden reply-box" id="reply-box-{{ child_comment.id }}">
                                        <div class="w-full rounded-lg border border-gray-300 bg-white-500 overflow-hidden">
                                            <textarea id="commentBox-{{ child_comment.id }}" placeholder="Add a reply..."
                                                      class="w-full p-2 transition-all h-10 resize-none"
                                                      style="border: none; outline: none; padding: 10px; resize: none; min-height: 80px; box-shadow: none;"></textarea>
                                            <div id="buttonContainer-{{ child_comment.id }}" class="justify-end p-2.5 border-t-none bg-white float-right">
                                                <button style="margin-right: 10px; padding: 5px 10px; border: none; background-color: white; border-radius: 15px;"
                                                        class="inline-flex items-center px-2 py-1 bg-gray-200 border border-gray-300 rounded-full hover:bg-gray-300 mr-2 text-sm"
                                                        onclick="cancelComment()">Cancel</button>
                                                <button style="padding: 5px 10px; border: none; background-color: #1a73e8; color: white; border-radius: 15px;"
                                                        class="inline-flex items-center px-2 py-1 bg-blue-600 text-white rounded-full hover:bg-blue-700 text-sm"
                                                        onclick="submitReply('{{ child_comment.id }}')">
                                                    Comment
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- LEVEL 3 REPLIES -->
                                    <div class="ml-4 mt-2">
                                        {% for grandchild_comment in child_comment.replies.all reversed %}
                                        <div id="comment-{{ grandchild_comment.id }}" class="flex flex-col gap-2 border-l-2 pl-2 mt-2">
                                            <div class="flex flex-row gap-2 items-start relative">
                                                <div class="w-[20px] h-[20px] rounded-full relative">
                                                    {% if grandchild_comment.user.avatar %}
                                                        {% if grandchild_comment.user.avatar|slice:":5" == "https" %}
                                                            <img class="w-[20px] h-[20px] rounded-full object-cover" 
                                                                src="{{ grandchild_comment.user.avatar }}" 
                                                                alt="{{ grandchild_comment.user.username }}">
                                                        {% else %}
                                                            <img class="w-[20px] h-[20px] rounded-full object-cover" 
                                                                src="{% static grandchild_comment.user.avatar %}" 
                                                                alt="{{ grandchild_comment.user.username }}">
                                                        {% endif %}
                                                    {% else %}
                                                        <div class="w-full h-full bg-black rounded-full"></div>
                                                    {% endif %}
                                                </div>
                                                <div class="flex flex-col gap-1 w-full">
                                                    <div class="flex flex-row gap-2 items-center">
                                                        <a href="{% url 'account:user_profile' grandchild_comment.user.username %}" 
                                                        class="font-semibold text-xs">
                                                            {{ grandchild_comment.user.username }}
                                                        </a>
                                                        <p class="text-xs text-gray-500">•</p>
                                                        <p class="text-xs text-gray-500" data-created-at="{{ grandchild_comment.created_at }}">
                                                            {{ grandchild_comment.created_at }}
                                                        </p>
                                                    </div>
                                                    <p class="text-xs">{{ grandchild_comment.content }}</p>
                                                    <div class="flex flex-row gap-2 mt-1">
                                                        <button class="text-xs text-pink-500 reply-button" 
                                                                data-parent-id="{{ grandchild_comment.id }}"
                                                                onclick="showReplyBox('{{ grandchild_comment.id }}')">
                                                            Reply
                                                        </button>
                                                        <button class="text-xs text-green-500 edit-button" 
                                                                data-comment-id="{{ grandchild_comment.id }}">
                                                            Edit
                                                        </button>
                                                        <button class="text-xs text-red-500 delete-button" 
                                                                data-comment-id="{{ grandchild_comment.id }}">
                                                            Delete
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}  <!-- LEVEL 3 REPLY TO LVL 2 -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}  <!-- LEVEL 2 REPLY TO ROOT COMMENT -->
                    </div>
                    
                </div>
            </div>
        </div>
        {% endfor %}  <!-- LEVEL 1 ROOT COMMENTS -->
    </div>

</div>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('[data-created-at]').forEach(element => {
            const timestamp = element.getAttribute('data-created-at');
            element.textContent = timeAgo(timestamp);
        });
    });

    function cancelComment() {
        document.getElementById('commentTextarea').value = '';
    }
    
    async function submitComment(postId, parentId = null) {
    // Get the correct comment box based on parentId
    const commentBox = parentId ? document.getElementById(`commentBox-${parentId}`) : document.getElementById("commentBox");

    if (commentBox.value.trim() === "") {
        alert("Comment box has no value");
        return;
    }

    // Send the POST request to submit the comment
    try {
        let data = new FormData();
        data.append('comment', commentBox.value);
        if (parentId) {
            data.append('parent_id', parentId); // Include parent ID if replying to a comment
        }

        const response = await fetch(`/post/comment/${postId}`, {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}", // Ensure CSRF token is correctly handled
            },
            body: data
        });

        if (response.ok) {
            const data = await response.json(); // Assuming the response contains the new comment details
            const commentsSection = document.getElementById(`comments-${postId}`);
            commentBox.value = ""; // Clear the comment box after submission

            // Check if comments section exists
            if (!commentsSection) {
                console.error(`Comments section for post ${postId} not found`);
                return;
            }

            const newCommentItem = document.createElement("div");
            newCommentItem.setAttribute("id", data.id);
            const created_at = timeAgo(data.created_at);


            // Construct the new comment item HTML
            newCommentItem.innerHTML = `
                <div id="${data.id}" class="flex flex-col gap-2 ${parentId ? 'border-l-2 pl-2' : ''}">
                    <div class="flex flex-row gap-2 items-start relative">
                        <div class="w-[30px] h-[30px] rounded-full relative">
                        {% if comment.user.avatar %}
                            {% if comment.user.avatar|slice:":5" == "https" %}
                                <img class="w-[30px] h-[30px] rounded-full object-cover" 
                                     src="{{ comment.user.avatar }}" 
                                     alt="{{ comment.user.username }}">
                            {% else %}
                                <img class="w-[30px] h-[30px] rounded-full object-cover" 
                                     src="{% static comment.user.avatar %}" 
                                     alt="{{ comment.user.username }}">
                            {% endif %}
                        {% else %}
                            <div class="w-full h-full bg-black rounded-full"></div>
                        {% endif %}
                    </div>
                        <span class="flex flex-row gap-1 items-start">
                            <a href="{% url 'account:user_profile' post.user.username %}" class="font-semibold text-sm leading-none">{{ post.user.username }}</a>
                            <p class="text-xs">•</p>
                            <p data-created-at="${timeAgo(data.created_at)}" class="font-semibold text-xs">${timeAgo(data.created_at)}</p>
                        </span>
                    </div>
                    <p class="text-sm">${data.content}</p> <!-- Add the content of the comment -->
                    <div class="flex flex-row gap-2 mt-1">
                        <button class="text-xs text-pink-500 reply-button" 
                                data-parent-id="${data.id}"
                                onclick="showReplyBox('${data.id}')">
                            Reply
                        </button>
                        <button class="text-xs text-green-500 edit-button" 
                                data-comment-id="${data.id}">
                            Edit
                        </button>
                        <button class="text-xs text-red-500 delete-button" 
                                data-comment-id="${data.id}">
                            Delete
                        </button>
                    </div>
                 </div>
                </div?
            `;

            // Append the new comment to the appropriate section
            if (parentId) {
                const parentComment = document.getElementById(parentId);
                if (parentComment) {
                    const childCommentsContainer = parentComment.querySelector('.child-comments');
                    if (childCommentsContainer) {
                        childCommentsContainer.prepend(newCommentItem);
                    }
                }
            } else {
                commentsSection.prepend(newCommentItem);
            }

            // Hide the button container after submission
            const buttonContainer = parentId ? document.getElementById(`buttonContainer-${parentId}`) : document.getElementById('buttonContainer');
            if (buttonContainer) {
                buttonContainer.classList.add('hidden');
            }

            document.getElementById('comment_count').textContent = parseInt(document.getElementById('comment_count').textContent) + 1;

        } else {
            alert("Failed to post comment.");
        }
    } catch (error) {
        console.error("Error submitting comment:", error);
        alert("There was an error submitting your comment.");
    }
}


function showReplyBox(commentId) {
    const replyBox = document.getElementById(`reply-box-${commentId}`);
    replyBox.classList.toggle('hidden'); 
}

function createReplyElement(data) {
    const newReply = document.createElement("div");
    newReply.id = `comment-${data.id}`;
    newReply.className = "flex flex-col gap-2 border-l-2 pl-2 mt-2";

    let avatarHtml = '<div class="w-full h-full bg-black rounded-full"></div>';
    if (data.user.avatar) {
        avatarHtml = `<img class="w-[25px] h-[25px] rounded-full object-cover" 
                           src="${data.user.avatar}" 
                           alt="${data.user.username}">`;
    }

    const formattedTime = data.created_at ? timeAgo(data.created_at) : 'just now';

    newReply.innerHTML = `
        <div class="flex flex-row gap-2 items-start relative">
            <div class="w-[25px] h-[25px] rounded-full relative">${avatarHtml}</div>
            <div class="flex flex-col gap-1 w-full">
                <div class="flex flex-row gap-2 items-center">
                    <a href="/account/user_profile/${data.user.username}" class="font-semibold text-sm">
                        ${data.user.username}
                    </a>
                    <p class="text-xs text-gray-500">•</p>
                    <p class="text-xs text-gray-500" data-created-at="${data.created_at}">
                        ${formattedTime}
                    </p>
                </div>
                <p class="text-sm">${data.content}</p>
                <div class="flex flex-row gap-2 mt-1">
                    <button class="text-xs text-pink-500 reply-button" 
                            data-parent-id="${data.id}"
                            onclick="showReplyBox('${data.id}')">
                        Reply
                    </button>
                    <button class="text-xs text-green-500 edit-button" 
                            data-comment-id="${data.id}">
                        Edit
                    </button>
                    <button class="text-xs text-red-500 delete-button" 
                            data-comment-id="${data.id}">
                        Delete
                    </button>
                </div>
                
                <div class="w-full mt-2 hidden reply-box" id="reply-box-${data.id}">
                    <div class="w-full rounded-lg border border-gray-300 bg-white-500 overflow-hidden">
                        <textarea id="commentBox-${data.id}" placeholder="Add a reply..."
                                  class="w-full p-2 transition-all h-10 resize-none"
                                  style="border: none; outline: none; padding: 10px; resize: none; min-height: 80px; box-shadow: none;"></textarea>
                        <div id="buttonContainer-${data.id}" class="justify-end p-2.5 border-t-none bg-white float-right">
                            <button class="inline-flex items-center px-2 py-1 bg-gray-200 border border-gray-300 rounded-full hover:bg-gray-300 mr-2 text-sm"
                                    onclick="cancelComment()">Cancel</button>
                            <button class="inline-flex items-center px-2 py-1 bg-blue-600 text-white rounded-full hover:bg-blue-700 text-sm"
                                    onclick="submitReply('${data.id}')">
                                Comment
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
    
    return newReply;
}


function submitReply(parentId) {
    const replyInput = document.getElementById(`commentBox-${parentId}`);
    const replyContent = replyInput.value.trim();
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    if (!replyContent) {
        alert("Reply cannot be empty.");
        return;
    }

    fetch(`/post/reply/${parentId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ content: replyContent }),
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        console.log('Response data:', data);
        let repliesContainer = document.querySelector(`#comment-${parentId} .child-comments`);
        if (!repliesContainer) {
            repliesContainer = document.createElement("div");
            repliesContainer.className = "child-comments ml-3 mt-2";
            document.getElementById(`comment-${parentId}`).appendChild(repliesContainer);
        }

        const newReply = createReplyElement(data);
        repliesContainer.prepend(newReply);
        
        replyInput.value = ""; 
        document.getElementById(`reply-box-${parentId}`).classList.add("hidden");
    })
    .catch(error => {
        console.error("Error submitting reply:", error);
        alert("Error submitting reply. Please try again.");
    });
}


function delete_comment(commentId) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    // Create a new form element
    let new_form = document.createElement("form");
    new_form.action = "/post/delete_comment/";  // Set the URL where the form should be submitted
    new_form.method = "POST";  // Set the form method to POST

    // Create the hidden input fields for commentId and CSRF token
    let content = `
        <input type="hidden" value="${ commentId }" name="comment_id">
        <input type="hidden" value="${ csrfToken }" name="csrfmiddlewaretoken">
    `;
    new_form.innerHTML += content;

    // Append the form to the document body and submit it
    document.body.appendChild(new_form);
    new_form.submit();
}
</script>
